# ETL Mapping: FRIL Legacy → GORE_OS IPR
# Prioridad: CRÍTICA (Inversión Comunitaria)
# Funtor: Δ*(MLEG-INICIATIVA-FRIL) → Σ*(ENT-FIN-IPR)
---
_meta:
  urn: urn:goreos:etl:map:ipr_fril:1.0.0
  type: ETL_Mapping
  created_at: "2025-12-22"
  author: Arquitecto-GORE

source:
  type: staging
  entity: ENT-MLEG-INICIATIVA-FRIL
  urn: urn:goreos:atom:entity:iniciativa_fril:1.0.0
  approx_rows: 500
  quality_tier: HIGH

target:
  type: canonical
  entity: ENT-FIN-IPR
  urn: urn:goreos:entity:fiscus:ipr:1.1.0
  domain: D-FIN

# Estrategia de claves
key_strategy:
  source_key: codigo_fril
  target_key: id_ipr
  generation: UUID_V5 # Namespace: gore_os, Name: ipr:fril:{codigo_fril}
  dedup_policy: MERGE_LATEST

# Contexto: FRIL es un MECANISMO específico
context:
  mecanismo: FRIL
  mecanismo_id: "{{LOOKUP:ENT-FIN-MECANISMO:codigo=FRIL:id_mecanismo}}"
  tipo_default: PROYECTO

# Mapeo de atributos
field_mappings:
  - source: codigo_fril
    target: codigo_bip
    transform: PREFIX
    prefix: "FRIL-"

  - source: nombre_proyecto
    target: nombre
    transform: TRIM_NORMALIZE

  - source: nombre_proyecto
    target: descripcion
    transform: COPY # Por ahora duplicamos; descripción completa podría venir de otra fuente

  - source: null
    target: tipo
    transform: CONSTANT
    value: PROYECTO

  - source: null
    target: mecanismo_id
    transform: LOOKUP_CONSTANT
    lookup:
      entity: ENT-FIN-MECANISMO
      match_field: codigo
      match_value: FRIL
      return_field: id_mecanismo

  - source: monto_aprobado
    target: monto_total
    transform: PARSE_DECIMAL_CLP
    null_handling: USE_SOLICITADO
    fallback_source: monto_solicitado

  - source: comuna
    target: comuna_id
    transform: LOOKUP
    lookup:
      entity: ENT-LOC-COMUNA
      match_field: nombre
      return_field: id_comuna
      on_miss: LOG_WARNING
      fuzzy_match: true
      threshold: 0.85

  - source: estado
    target: estado_ciclo
    transform: ENUM_MAP
    enum_map:
      POSTULACION: FORMULACION
      EVALUACION: EVALUACION
      APROBADO: APROBADO
      EJECUCION: EJECUCION
      TERMINADO: TERMINADO
      RECHAZADO: RECHAZADO
    default: FORMULACION

  - source: estado
    target: etapa_actual
    transform: DERIVE_ETAPA
    derive_map:
      POSTULACION: PERFIL
      EVALUACION: EVALUACION_RATE
      APROBADO: ASIGNACION_PRESUPUESTARIA
      EJECUCION: EN_EJECUCION
      TERMINADO: CIERRE
      RECHAZADO: RECHAZADO

  - source: anio_convocatoria
    target: fecha_rs
    transform: YEAR_TO_DATE
    pattern: "{year}-01-01" # Primera fecha del año

  # --- metadata_mecanismo (específico FRIL) ---
  - source: _build_metadata
    target: metadata_mecanismo
    transform: JSON_BUILD
    structure:
      organizacion_beneficiaria: "{organizacion_beneficiaria}"
      rut_organizacion: "{rut_organizacion}"
      monto_solicitado: "{monto_solicitado}"
      monto_aprobado: "{monto_aprobado}"
      anio_convocatoria: "{anio_convocatoria}"
      fuente_legacy: "FRIL"

# Campos target con defaults
unmapped_targets:
  - field: vigencia
    default: VIGENTE
  - field: tipologia
    source: null
    note: "Clasificación SNI no aplica a FRIL"
  - field: origen
    default: FRIL
  - field: fuente
    default: "FNDR"
  - field: sub_estado
    source: null
  - field: rate_actual
    source: null
    note: "FRIL no tiene RATE SNI"
  - field: fecha_rate
    source: null
  - field: n_rates_emitidos
    default: 0
  - field: rate_historico
    default: "[]"
  - field: marco_logico
    source: null
    note: "FRIL simplified - no marco lógico formal"

# Dependencias
dependencies:
  pre_load:
    - entity: ENT-FIN-MECANISMO
      ensure_exists: "FRIL"
    - entity: ENT-LOC-COMUNA
      from: MLEG-INICIATIVA-FRIL.comuna
      strategy: LOOKUP_ONLY

# Validaciones post-carga
validation_rules:
  - rule: NOT_NULL
    fields: [codigo_bip, nombre, monto_total, estado_ciclo]
  - rule: FK_EXISTS
    field: mecanismo_id
    target: ENT-FIN-MECANISMO
  - rule: FK_EXISTS_OR_NULL
    field: comuna_id
    target: ENT-LOC-COMUNA
  - rule: POSITIVE
    field: monto_total

# Métricas esperadas
expected_metrics:
  source_rows: 500
  target_rows_min: 480
  target_rows_max: 500
  null_rate_max:
    comuna_id: 0.10
    monto_total: 0.02
