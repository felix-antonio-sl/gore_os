# ==============================================================================
# GORE_OS Entity Atom: AlertaCiclo (Alerta de Ciclo de Vida IPR)
# ==============================================================================
# Domain: D-FIN (Financial Management)
# Subdomain: Portafolio
# Source: kb_gn_019_gestion_ipr_koda.yml, CRM-IPR Design
# ==============================================================================

_metadata:
  version: "1.0.0"
  status: active
  created_at: "2025-12-21"
  created_by: "Arquitecto Categórico"
  domain: D-FIN
  subdomain: portafolio
  kb_source:
    - "kb_gn_019_gestion_ipr_koda.yml"
    - "dialogo_profundo_crm_ipr.md"

entity:
  id: ENT-FIN-ALERTA-CICLO
  name: AlertaCiclo
  name_es: Alerta de Ciclo de Vida
  description: |
    Notificación automática o manual generada cuando una IPR o convenio
    se acerca a un vencimiento, incumple un plazo, o presenta una condición
    que requiere atención. Parte del sistema de monitoreo CRM-IPR.

    Los tipos incluyen: vencimiento de plazo, rendición pendiente,
    inactividad prolongada, riesgo de caducidad, entre otros.

  purpose: |
    Modelar el sistema de alertas tempranas para:
    - Prevenir vencimientos de plazos y convenios
    - Detectar IPRs en riesgo de caducidad BIP
    - Notificar rendiciones pendientes
    - Escalar incidencias a niveles superiores

  categorical_type: Object
  is_abstract: false
  category: Transactional

  extends: null

  related_to:
    - entity: ENT-FIN-IPR
      relation: alerta_sobre
      cardinality: N:0..1
      description: IPR que genera la alerta
    - entity: ENT-FIN-CONVENIO
      relation: alerta_convenio
      cardinality: N:0..1
      description: Convenio que genera la alerta

attributes:
  - name: id_alerta
    type: String
    key: true
    description: Identificador único de la alerta

  - name: fecha_emision
    type: DateTime
    nullable: false
    description: Momento de generación de la alerta

  # Objeto alertado
  - name: ipr_id
    type: String
    fk: ENT-FIN-IPR
    nullable: true
    description: IPR relacionada

  - name: convenio_id
    type: String
    fk: ENT-FIN-CONVENIO
    nullable: true
    description: Convenio relacionado

  - name: actor_id
    type: String
    fk: ENT-FIN-ACTOR_IPR
    nullable: true
    description: Ejecutor si la alerta es sobre rendiciones

  # Clasificación
  - name: tipo_alerta
    type: Enum[VencimientoPlazo, RendicionPendiente, InactividadProlongada, RiesgoCaducidadBIP, AtrasoHito, ConvenioProximoVencer, GarantiaProximoVencer, ObservacionSinSubsanar, PresupuestoSinEjecutar, DesvioMayor]
    nullable: false
    description: Tipo de condición alertada

  - name: severidad
    type: Enum[Informativa, Advertencia, Critica, Urgente]
    nullable: false
    description: Nivel de urgencia de la alerta

  - name: fase_ciclo
    type: Enum[Formulacion, Evaluacion, Financiamiento, Ejecucion, Rendicion, Cierre]
    nullable: true
    description: Fase del ciclo de vida donde se detecta

  # Detalle
  - name: titulo
    type: String
    nullable: false
    description: Título descriptivo de la alerta

  - name: descripcion
    type: Text
    nullable: true
    description: Detalle de la situación

  - name: fecha_limite
    type: Date
    nullable: true
    description: Fecha límite del evento alertado

  - name: dias_restantes
    type: Integer
    computed: true
    formula: fecha_limite - fecha_actual
    description: Días hasta el vencimiento

  - name: dias_desde_deteccion
    type: Integer
    computed: true
    formula: fecha_actual - fecha_emision
    description: Días desde que se emitió la alerta

  # Origen
  - name: origen
    type: Enum[Automatico, ManualFuncionario, SistemaBIP, IntegracionSIGFE]
    default: Automatico
    description: Cómo se generó la alerta

  - name: regla_generadora
    type: String
    nullable: true
    description: ID de la regla de negocio que disparó la alerta

  # Destinatarios
  - name: destinatario_principal_id
    type: String
    fk: ROL-FUNCIONARIO
    nullable: true
    description: Funcionario principal responsable

  - name: destinatarios_copia
    type: Array[String]
    nullable: true
    description: Otros funcionarios notificados

  - name: escalar_a_id
    type: String
    fk: ROL-JEFATURA
    nullable: true
    description: Jefatura a escalar si no se atiende

  # Estado
  - name: estado
    type: Enum[Activa, Reconocida, EnAtencion, Resuelta, Escalada, Vencida, Descartada]
    default: Activa
    description: Estado de gestión de la alerta

  - name: fecha_reconocimiento
    type: DateTime
    nullable: true
    description: Cuándo alguien tomó conocimiento

  - name: fecha_resolucion
    type: DateTime
    nullable: true
    description: Cuándo se resolvió la situación

  - name: resolucion_comentario
    type: String
    nullable: true
    description: Cómo se resolvió

  # Escalamiento
  - name: dias_para_escalar
    type: Integer
    default: 3
    description: Días sin atender antes de escalar

  - name: fue_escalada
    type: Boolean
    default: false
    description: Si la alerta fue escalada

  - name: fecha_escalamiento
    type: DateTime
    nullable: true
    description: Cuándo se escaló

invariants:
  - id: INV-ALE-001
    name: tiene_objeto_alertado
    rule: |
      ipr_id IS NOT NULL OR convenio_id IS NOT NULL OR actor_id IS NOT NULL
    description: La alerta debe referirse a algún objeto
    severity: error

  - id: INV-ALE-002
    name: resuelta_tiene_comentario
    rule: |
      (estado = 'Resuelta') → resolucion_comentario IS NOT NULL
    description: La resolución requiere documentación
    severity: warning

  - id: INV-ALE-003
    name: escalar_automaticamente
    rule: |
      (estado = 'Activa' AND dias_desde_deteccion > dias_para_escalar) →
      estado = 'Escalada' AND fue_escalada = true
    description: Escalar si no se atiende en plazo

  - id: INV-ALE-004
    name: critica_requiere_escalamiento
    rule: |
      (severidad = 'Critica' OR severidad = 'Urgente') →
      escalar_a_id IS NOT NULL
    description: Alertas críticas deben tener definido escalamiento

lifecycle:
  states:
    - name: Activa
      description: Alerta emitida, pendiente de atención
    - name: Reconocida
      description: Alguien tomó conocimiento
    - name: EnAtencion
      description: Se está trabajando en resolver
    - name: Resuelta
      description: Situación corregida
    - name: Escalada
      description: Enviada a nivel superior por inacción
    - name: Vencida
      description: El plazo expiró sin resolución
    - name: Descartada
      description: Falso positivo o no aplica

  transitions:
    - from: Activa
      to: Reconocida
      trigger: reconocer
    - from: Activa
      to: Escalada
      trigger: escalar_automaticamente
      guard: dias_desde_deteccion > dias_para_escalar
    - from: Reconocida
      to: EnAtencion
      trigger: iniciar_atencion
    - from: EnAtencion
      to: Resuelta
      trigger: resolver
    - from: Activa
      to: Vencida
      trigger: vencer
      guard: fecha_limite < fecha_actual
    - from: Activa
      to: Descartada
      trigger: descartar

morphisms:
  alerta_sobre: [ENT-FIN-IPR, ENT-FIN-CONVENIO, ENT-FIN-ACTOR_IPR]
  notifica_a: [ROL-FUNCIONARIO]
  escala_a: [ROL-JEFATURA]
  disparada_por: [ReglaDeNegocio]

audit:
  fields_tracked:
    - estado
    - fue_escalada
  retention_years: 3
