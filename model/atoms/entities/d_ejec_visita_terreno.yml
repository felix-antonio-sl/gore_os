# Entidad: VisitaTerreno
# Domain: D-EJEC
# Generated: 2025-12-21 (Phase 20.2)

id: ENT-EJEC-VISITA_TERRENO
urn: "urn:goreos:entity:d-ejec:visita-terreno:1.0.0"
name: Visita a Terreno
domain: D-EJEC
category: Operational
canonical_source:
  - "domain_d-ejec.md#p3-supervisión-de-obra"
  - "Ley 19.886 - Control de obras"

description: |
  Registro de inspección física de obras en ejecución.
  Incluye fotografías geolocalizadas, hallazgos y evaluación de avance.
  Detecta desviaciones que pueden activar protocolo FÉNIX.

attributes:
  - name: id_visita
    type: String
    key: true

  - name: convenio_id
    type: String
    fk: ENT-FIN-CONVENIO
    nullable: false

  - name: numero_visita
    type: Integer
    nullable: false

  # Programación
  - name: fecha_programada
    type: Date
    nullable: true

  - name: fecha_visita
    type: Date
    nullable: false

  - name: hora_inicio
    type: Time
    nullable: true

  - name: hora_termino
    type: Time
    nullable: true

  # Ubicación
  - name: ubicacion_gps
    type: Point
    nullable: true
    description: Coordenadas GPS de la visita

  - name: comuna
    type: String
    nullable: true

  - name: direccion
    type: String
    nullable: true

  # Inspector
  - name: inspector_id
    type: String
    fk: ROL-SUPERVISOR
    nullable: false

  - name: inspector_nombre
    type: String
    nullable: false

  - name: cargo_inspector
    type: String
    nullable: true

  # Participantes
  - name: participantes_ejecutor
    type: List[String]
    nullable: true

  - name: participantes_gore
    type: List[String]
    nullable: true

  # Evaluación
  - name: avance_fisico_observado
    type: Decimal
    nullable: true
    description: Porcentaje de avance físico estimado

  - name: calidad_ejecucion
    type: Enum[Excelente, Buena, Regular, Deficiente, Critica]
    nullable: true

  # Hallazgos
  - name: hallazgos
    type: Text
    nullable: true

  - name: desviaciones_detectadas
    type: Boolean
    default: false

  - name: porcentaje_desviacion
    type: Decimal
    nullable: true

  - name: tipo_desviacion
    type: Enum[Plazo, Costo, Calidad, Alcance, Ninguna]
    nullable: true

  # Fotografías
  - name: fotografias
    type: List[String]
    nullable: true
    description: URLs de fotografías geolocalizadas

  - name: cantidad_fotos
    type: Integer
    default: 0

  # Estado
  - name: estado
    type: Enum[Programada, Realizada, Cancelada, Reprogramada]
    default: Programada

  # Acciones derivadas
  - name: requiere_alerta
    type: Boolean
    default: false

  - name: nivel_alerta
    type: Enum[Ninguna, Amarilla, Roja, Negra]
    default: Ninguna

  - name: fenix_activado
    type: Boolean
    default: false

  - name: observaciones
    type: Text
    nullable: true

invariants:
  - name: desviacion_genera_alerta
    rule: "IF porcentaje_desviacion > 10 THEN requiere_alerta = true"
    source: "domain_d-ejec.md"

  - name: fotos_obligatorias
    rule: "IF estado = Realizada THEN cantidad_fotos >= 1"

morphisms:
  supervisa: [ENT-FIN-CONVENIO]
  ejecutada_por: [ROL-SUPERVISOR]
  genera: [ENT-EJEC-BITACORA_OBRA]
  puede_activar: [FENIX]
  geolocalizada_en: [ENT-TERR-CAPAGEOESPACIAL]
