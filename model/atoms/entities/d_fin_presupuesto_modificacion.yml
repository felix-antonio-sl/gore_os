# Entidad: ModificacionPresupuestaria
# Domain: D-FIN
# Subdomain: presupuesto
# Generated: 2025-12-21 (Phase 20.2 - ERP/Compliance Deep Enrichment)

id: ENT-FIN-MODIF_PRESUPUESTARIA
urn: "urn:goreos:entity:d-fin:modif-presupuestaria:1.0.0"
name: Modificación Presupuestaria
domain: D-FIN
subdomain: presupuesto
category: Transactional
canonical_source:
  - "agent_erp_gore.yaml#S-PRESUPUESTO"
  - "DL 1263/1975 Art. 26"
  - "kb_gn_019_gestion_ipr_koda.yml"

description: |
  Transacción que altera el presupuesto vigente.
  Permite reasignaciones, suplementos o reducciones.
  Requiere diferentes niveles de aprobación y actos administrativos según tipología.

attributes:
  - name: id_modificacion
    type: String
    key: true

  - name: numero_solicitud
    type: String
    nullable: true

  - name: fecha_solicitud
    type: Date
    nullable: false

  # Clasificación
  - name: tipo_modificacion
    type: Enum[ReasignacionInterna, Suplemento, Reduccion, TransferenciaCapital, AporteFiscal]
    nullable: false

  - name: nivel_aprobacion
    type: Enum[Nivel1_DAF, Nivel2_GORE_CORE, Nivel3_DIPRES]
    nullable: false
    description: Nivel jerárquico requerido para aprobar el cambio

  # Contenido
  - name: justificacion
    type: Text
    nullable: false

  - name: monto_total_movimiento
    type: Decimal
    nullable: false
    description: Suma absoluta de movimientos (debe cuadrar)

  - name: movimientos
    type: List[YAML]
    nullable: false
    description: Lista de {cuenta_origen, cuenta_destino, monto, programa_presupuestario}

  # Vinculación Legal (Compliance)
  - name: acto_administrativo_id
    type: String
    fk: ENT-FIN-ACTO_ADMINISTRATIVO
    nullable: true
    description: Resolución o Decreto que aprueba legalmente la modificación

  - name: estado
    type: Enum[Borrador, Solicitada, EnRevision, AprobadaTecnicamente, EnTramiteLegal, Vigente, Rechazada]
    default: Borrador

  # Vinculación Operativa
  - name: origen_solicitud
    type: Enum[IPR, Glosa02, Emergencia, AjusteCierre]
    nullable: true

  - name: ipr_id
    type: String
    fk: ENT-FIN-IPR
    nullable: true
    description: Si la modificación es específica para un proyecto

invariants:
  - name: cuadratura_movimientos
    rule: "IF tipo_modificacion = ReasignacionInterna THEN sum(origen) = sum(destino)"

  - name: legalidad_requerida
    rule: "IF estado = Vigente THEN acto_administrativo_id NOT NULL"

morphisms:
  modifica: [ENT-FIN-CDP]
  aprobado_por: [DAF, GORE, DIPRES]
  formalizado_en: [ENT-FIN-ACTO_ADMINISTRATIVO]
