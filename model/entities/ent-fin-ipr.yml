---
_meta:
  urn: urn:goreos:entity:fiscus:ipr:1.1.0
  type: Entity
  schema: urn:goreos:schema:entity:1.0.0
id: ENT-FIN-IPR
name: Intervención Pública Regional
domain: D-FIN
category: Master
description: "Objeto central del ciclo de inversión"
attributes:
  - { name: id_ipr, type: UUID, key: true }
  - { name: codigo_bip, type: String }
  - { name: nombre, type: String }
  - { name: descripcion, type: Text }
  - { name: tipo, type: String }
  - { name: mecanismo_id, type: UUID, fk: ENT-FIN-MECANISMO }
  - { name: monto_total, type: Decimal }
  - { name: comuna_id, type: UUID, fk: ENT-LOC-COMUNA }
  - { name: estado_ciclo, type: String }
  - { name: etapa_actual, type: String }
  - { name: fecha_rs, type: Date }
  - { name: vigencia, type: String, nullable: true }
  - { name: tipologia, type: String, nullable: true }
  - { name: origen, type: String, nullable: true }
  - { name: fuente, type: String, nullable: true }
  - { name: sub_estado, type: String, nullable: true }
  - { name: rate_actual, type: String, nullable: true }
  - { name: fecha_rate, type: Date, nullable: true }
  - { name: n_rates_emitidos, type: Integer, nullable: true }
  # === Extensión Cobertura IPR v2.0 ===
  - {
      name: metadata_mecanismo,
      type: JSON,
      nullable: true,
      description: "Datos específicos del mecanismo, validados contra ENT-FIN-MECANISMO.schema_metadata",
    }
  # === Extensión Gaps Auditoría v2.1 ===
  - {
      name: rate_historico,
      type: JSON,
      nullable: true,
      description: "Historial de evaluaciones RATE [{fecha, tipo, resultado, observaciones}]",
    }
  - {
      name: marco_logico,
      type: JSON,
      nullable: true,
      description: "Marco Lógico PPR {fin, proposito, componentes[], indicadores[]}",
    }
  # === Extensión data-gore D4_IPR + Para-Titi Ownership ===
  - {
      name: responsable_id,
      type: UUID,
      fk: ENT-ORG-FUNCIONARIO,
      nullable: true,
    }
  - {
      name: division_responsable_id,
      type: UUID,
      fk: ENT-ORG-DIVISION,
      nullable: true,
    }
  - {
      name: nivel_alerta,
      type: String,
      nullable: true,
      description: "NORMAL|INFO|ATENCION|ALTO|CRITICO",
    }
  - { name: tiene_problemas_abiertos, type: Boolean, default: false }
  - {
      name: indicadores_gestion,
      type: JSON,
      nullable: true,
      description: "{problemas_count, compromisos_count, alertas_count}",
    }
  # === Extensión Taxonomía Categorial IPR v3.0 ===
  - {
      name: fondo_id,
      type: UUID,
      fk: ENT-FIN-FONDO,
      nullable: true,
      description: "Fuente de recursos (FNDR, FRIL, FRPD, ISAR)",
    }
  - {
      name: via_evaluacion_id,
      type: UUID,
      fk: ENT-FIN-VIA-EVALUACION,
      nullable: true,
      description: "Mecanismo procesal de evaluación (SNI, C33, 8%, Glosa06, etc.)",
    }

# === Invariantes Categoriales ===
invariants:
  - id: IPR-VIA-EXCLUSIVA
    description: "Una IPR sigue UNA y SOLO UNA vía de evaluación"
    expression: "∀ ipr: |via_evaluacion_id| ≤ 1"

  - id: IPR-FONDO-VIA-COHERENCIA
    description: "ISAR nunca se procesa por vías 8% o FRPD; cada fondo tiene vías compatibles"
    expression: |
      ∀ ipr: 
        fondo.codigo = 'ISAR' → via.codigo ∈ {SNI_GENERAL, CIRCULAR_33}
        fondo.codigo = 'FRIL' → via.codigo = 'FRIL_VIA'
        fondo.codigo = 'FRPD' → via.codigo = 'FRPD_VIA'
