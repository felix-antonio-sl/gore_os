# ETL Mapping: Convenios Legacy → GORE_OS
# Prioridad: CRÍTICA (Negocio Core)
# Funtor: Δ*(MLEG-CONVENIO) → Σ*(ENT-EJE-CONVENIO)
---
_meta:
  urn: urn:goreos:etl:map:convenios:1.0.0
  type: ETL_Mapping
  created_at: "2025-12-22"
  author: Arquitecto-GORE

source:
  type: staging
  entity: ENT-MLEG-CONVENIO
  urn: urn:goreos:atom:entity:convenio:1.0.0
  approx_rows: 544
  quality_tier: MEDIUM

target:
  type: canonical
  entity: ENT-EJE-CONVENIO
  urn: urn:goreos:entity:actio:convenio:1.1.0
  domain: D-EJE

# Estrategia de claves
key_strategy:
  source_key: codigo
  target_key: id_convenio
  generation: UUID_V5  # Namespace: gore_os, Name: convenio:{codigo}
  dedup_policy: KEEP_FIRST  # ~10 duplicados detectados

# Mapeo de atributos
field_mappings:
  # --- Mapeos directos ---
  - source: codigo
    target: numero
    transform: TRIM

  - source: monto_total
    target: monto_total
    transform: PARSE_DECIMAL_CLP
    null_handling: ZERO

  - source: tipo_convenio
    target: tipo_convenio
    transform: ENUM_MAP
    enum_map:
      TRANSFERENCIA: TRANSFERENCIA
      TRASNFERENCIA: TRANSFERENCIA  # Corrige typo
      MANDATO: MANDATO
      COLABORACION: COLABORACION
    default: TRANSFERENCIA

  - source: estado
    target: estado
    transform: ENUM_MAP
    enum_map:
      VIGENTE: VIGENTE
      TERMINADO: TERMINADO
      RESCINDIDO: RESCINDIDO
      EN EJECUCION: VIGENTE
      LIQUIDADO: TERMINADO
    default: VIGENTE

  - source: fecha_resolucion
    target: fecha_firma
    transform: PARSE_DATE
    formats: ["DD-MM-YYYY", "DD/MM/YY", "YYYY-MM-DD"]

  # --- Derivaciones ---
  - source: institucion_rut
    target: ejecutor_id
    transform: LOOKUP
    lookup:
      entity: ENT-EJE-EJECUTOR
      match_field: rut
      return_field: id_ejecutor
      on_miss: CREATE_PLACEHOLDER

  - source: institucion_nombre
    target: _ejecutor_nombre  # Campo auxiliar para creación de ejecutor
    transform: TRIM

  # --- Agregaciones de hitos → metadata_legal ---
  - source: _aggregated_hitos
    target: metadata_legal
    transform: JSON_BUILD
    structure:
      res_aprueba: "hitos.filter(tipo='APRUEBA').first().numero_documento"
      res_incorpora: "hitos.filter(tipo='INCORPORA').first().numero_documento"
      res_crea: "hitos.filter(tipo='CREA').first().numero_documento"
      toma_razon: "hitos.filter(tipo='TOMA_RAZON_CGR').first().numero_documento"
      fecha_toma_razon: "hitos.filter(tipo='TOMA_RAZON_CGR').first().fecha_documento"

# Campos target sin fuente (defaults/nullables)
unmapped_targets:
  - field: ipr_id
    source: null
    note: "Requiere join posterior con IPR por codigo_bip"
  - field: fecha_inicio
    source: null
    default: null
  - field: fecha_termino
    source: null
    default: null
  - field: plazo_meses
    source: null
    default: null
  - field: referente_tecnico_id
    source: null
    default: null
  - field: estado_cgr
    source: null
    note: "Derivar de metadata_legal.toma_razon"
  - field: fecha_toma_razon
    source: null
    note: "Derivar de metadata_legal.fecha_toma_razon"

# Entidades dependientes (deben procesarse antes o en paralelo)
dependencies:
  pre_load:
    - entity: ENT-EJE-EJECUTOR
      from: MLEG-CONVENIO.institucion_*
      strategy: UPSERT_BY_RUT
  post_load:
    - entity: ENT-EJE-HITO
      from: MLEG-HITO-CONVENIO
      fk: convenio_id
    - entity: ENT-EJE-MODIFICACION_CONVENIO
      from: MLEG-MODIFICACION-CONVENIO
      fk: convenio_id

# Validaciones post-carga
validation_rules:
  - rule: NOT_NULL
    fields: [numero, monto_total, estado]
  - rule: FK_EXISTS
    field: ejecutor_id
    target: ENT-EJE-EJECUTOR
  - rule: UNIQUE
    field: numero
    scope: GLOBAL

# Métricas esperadas
expected_metrics:
  source_rows: 544
  target_rows_min: 500  # Después de dedup
  target_rows_max: 544
  null_rate_max:
    ejecutor_id: 0.05
    monto_total: 0.01
