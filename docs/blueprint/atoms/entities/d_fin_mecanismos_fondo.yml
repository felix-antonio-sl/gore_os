# ═══════════════════════════════════════════════════════════════════════════════
# ENT-FIN-FONDO | Fondo de Financiamiento Regional
# Dominio: D-FIN
# Subdomain: mecanismos
# Fuente: kb_gn_011_selector_ipr_koda.yml, kb_gn_018_gestion_prpto_koda.yml
# ═══════════════════════════════════════════════════════════════════════════════
version: "1.0.0"

metadata:
  entity_id: ENT-FIN-FONDO
  name: FondoFinanciamientoRegional
  domain: D-FIN
  subdomain: mecanismos
  description: |
    Representa los fondos de financiamiento administrados por el GORE
    para inversión regional. Incluye FNDR, FRIL, FRPD (Royalty) y
    el 8% de Vinculación con la Comunidad.
  legal_basis:
    - LOC GORE Art. 36, 78
    - Ley de Presupuestos Partida 31
    - Glosas 07, 12 Ley 21.796

# ═══════════════════════════════════════════════════════════════════════════════
# ATRIBUTOS
# ═══════════════════════════════════════════════════════════════════════════════
attributes:
  - name: id_fondo
    type: String
    key: true

  - name: codigo_fondo
    type: Enum[FNDR, FRIL, FRPD, PCT8, EMERGENCIA, ASOCIATIVIDAD]
    nullable: false
    description: |
      FNDR: Fondo Nacional de Desarrollo Regional
      FRIL: Fondo Regional de Iniciativa Local
      FRPD: Fondo Regional para la Productividad y el Desarrollo (Royalty)
      PCT8: 8% Vinculación con la Comunidad
      EMERGENCIA: 3% para emergencias (Glosa 14)
      ASOCIATIVIDAD: Programa Asociatividad y Planes Especiales

  - name: nombre
    type: String
    nullable: false

  - name: descripcion
    type: Text
    nullable: true

  # ─────────────────────────────────────────────────────────────────────────────
  # Clasificación Presupuestaria
  # ─────────────────────────────────────────────────────────────────────────────
  - name: subtitulo_principal
    type: String
    nullable: false
    description: "31, 33, 24 según naturaleza del fondo"

  - name: item
    type: String
    nullable: true

  - name: asignacion
    type: String
    nullable: true
    description: "Ej: 33.03 para FRPD"

  - name: glosa_habilitante
    type: String
    nullable: true
    description: "Ej: Glosa 07, Glosa 12"

  # ─────────────────────────────────────────────────────────────────────────────
  # Presupuesto Anual
  # ─────────────────────────────────────────────────────────────────────────────
  - name: ejercicio
    type: Integer
    nullable: false

  - name: presupuesto_inicial
    type: Decimal
    nullable: false
    description: Presupuesto aprobado en Ley

  - name: presupuesto_vigente
    type: Decimal
    nullable: false
    description: Presupuesto después de modificaciones

  - name: comprometido_acumulado
    type: Decimal
    default: 0

  - name: devengado_acumulado
    type: Decimal
    default: 0

  - name: pagado_acumulado
    type: Decimal
    default: 0

  - name: saldo_disponible
    type: Decimal
    computed: true
    formula: presupuesto_vigente - comprometido_acumulado

  # ─────────────────────────────────────────────────────────────────────────────
  # Reglas de Uso
  # ─────────────────────────────────────────────────────────────────────────────
  - name: tipos_ejecutor_permitidos
    type: Array[Enum[GORE, Municipio, Servicio, Universidad, ONG, Privado, OSFL]]
    nullable: false
    description: Tipos de ejecutor habilitados para este fondo

  - name: requiere_evaluacion_mdsf
    type: Boolean
    default: true
    description: Si las IPR del fondo requieren evaluación MDSF

  - name: requiere_concurso
    type: Boolean
    default: true
    description: Si la asignación es por concurso

  - name: permite_asignacion_directa
    type: Boolean
    default: false

  - name: porcentaje_asignacion_directa_max
    type: Decimal
    nullable: true
    description: "10% para 8% FNDR según Glosa 07"

  - name: monto_asignacion_directa_acumulado
    type: Decimal
    default: 0

  # ─────────────────────────────────────────────────────────────────────────────
  # Límites Específicos
  # ─────────────────────────────────────────────────────────────────────────────
  - name: tope_costo_utm
    type: Decimal
    nullable: true
    description: "5.000 UTM para FRIL"

  - name: porcentaje_minimo_cultura
    type: Decimal
    nullable: true
    description: "1% mínimo a cultura para 8%"

  - name: porcentaje_administracion_gore
    type: Decimal
    default: 0.05
    description: "5% para gastos de administración Glosa 06"

  # ─────────────────────────────────────────────────────────────────────────────
  # Estado
  # ─────────────────────────────────────────────────────────────────────────────
  - name: estado
    type: Enum[Activo, Agotado, Cerrado]
    default: Activo

  - name: fecha_cierre_ejercicio
    type: Date
    nullable: true

# ═══════════════════════════════════════════════════════════════════════════════
# INVARIANTES
# ═══════════════════════════════════════════════════════════════════════════════
invariants:
  - id: INV-FONDO-001
    name: fril_solo_municipios
    rule: |
      (codigo_fondo = FRIL) → 
      tipos_ejecutor_permitidos = [Municipio]
    description: FRIL es exclusivo para municipalidades

  - id: INV-FONDO-002
    name: asignacion_directa_limite
    rule: |
      monto_asignacion_directa_acumulado <= 
      (porcentaje_asignacion_directa_max * presupuesto_vigente)
    description: Asignaciones directas no superan límite porcentual

  - id: INV-FONDO-003
    name: saldo_no_negativo
    rule: saldo_disponible >= 0
    description: No puede comprometerse más de lo disponible

  - id: INV-FONDO-004
    name: cultura_minimo_8pct
    rule: |
      (codigo_fondo = PCT8) → 
      SUM(IPR.monto WHERE sector = Cultura) >= 0.01 * presupuesto_vigente
    description: 8% debe destinar mínimo 1% a cultura y patrimonio

  - id: INV-FONDO-005
    name: emergencia_3pct_limite
    rule: |
      (codigo_fondo = EMERGENCIA) → 
      presupuesto_vigente <= 0.03 * total_inversion_regional
    description: Emergencias limitadas al 3% del presupuesto de inversión

# ═══════════════════════════════════════════════════════════════════════════════
# MORFISMOS
# ═══════════════════════════════════════════════════════════════════════════════
morphisms:
  - source: ENT-FIN-FONDO
    target: ENT-FIN-IPR
    type: 1:N
    name: iprs_financiadas
    description: IPRs financiadas con cargo a este fondo

  - source: ENT-FIN-FONDO
    target: ENT-FIN-CONCURSO
    type: 1:N
    name: concursos_abiertos
    description: Concursos gestionados bajo este fondo

  - source: ENT-FIN-FONDO
    target: ENT-FIN-ASIGNACION_PRESUPUESTARIA
    type: N:1
    name: asignacion_ppto
    description: Asignación presupuestaria de origen

# ═══════════════════════════════════════════════════════════════════════════════
# INSTANCIAS CONOCIDAS
# ═══════════════════════════════════════════════════════════════════════════════
known_instances:
  - codigo_fondo: FNDR
    nombre: "Fondo Nacional de Desarrollo Regional"
    subtitulo_principal: "33"
    tipos_ejecutor_permitidos: [GORE, Municipio, Servicio, Universidad, ONG]
    requiere_evaluacion_mdsf: true
    requiere_concurso: false

  - codigo_fondo: FRIL
    nombre: "Fondo Regional de Iniciativa Local"
    subtitulo_principal: "33"
    item: "33.01"
    glosa_habilitante: "Glosa 12"
    tipos_ejecutor_permitidos: [Municipio]
    requiere_evaluacion_mdsf: false
    requiere_concurso: true
    tope_costo_utm: 5000

  - codigo_fondo: FRPD
    nombre: "Fondo Regional para la Productividad y el Desarrollo"
    subtitulo_principal: "33"
    asignacion: "33.03"
    tipos_ejecutor_permitidos: [GORE, Municipio, Universidad, Privado]
    requiere_evaluacion_mdsf: false
    requiere_concurso: true

  - codigo_fondo: PCT8
    nombre: "Concurso 8% Vinculación con la Comunidad"
    subtitulo_principal: "24"
    item: "24.01"
    glosa_habilitante: "Glosa 07"
    tipos_ejecutor_permitidos: [Municipio, OSFL, ONG]
    requiere_evaluacion_mdsf: false
    requiere_concurso: true
    permite_asignacion_directa: true
    porcentaje_asignacion_directa_max: 0.10
    porcentaje_minimo_cultura: 0.01
