# Entidad: BitacoraViaje
# Domain: D-BACK
# Subdomain: flota
# Generated: 2025-12-21 (Phase 20.1b - Gaps)

id: ENT-BACK-BITACORA_VIAJE
urn: "urn:goreos:entity:d-back:bitacora-viaje:1.0.0"
name: Bitácora de Viaje
domain: D-BACK
subdomain: flota
category: Operational
canonical_source:
  - "DL 799/1974"
  - "domain_d-back.md#5-flota-vehicular"
  - "manual_2_4_flota_vehicular.yml"

description: |
  Registro de cada uso de vehículo institucional.
  Controla kilometraje, combustible, chofer y destino.
  Obligatorio por DL 799 para vehículos fiscales.

attributes:
  - name: id_bitacora
    type: String
    key: true

  - name: vehiculo_id
    type: String
    fk: ENT-BACK-VEHICULO
    nullable: false

  # Datos del viaje
  - name: fecha_salida
    type: DateTime
    nullable: false

  - name: fecha_retorno
    type: DateTime
    nullable: true

  - name: km_salida
    type: Integer
    nullable: false

  - name: km_retorno
    type: Integer
    nullable: true

  - name: km_recorridos
    type: Integer
    computed: true
    formula: km_retorno - km_salida

  # Destino
  - name: destino
    type: String
    nullable: false

  - name: comuna_destino
    type: String
    nullable: true

  - name: motivo
    type: Text
    nullable: false

  - name: referencia_cometido
    type: String
    nullable: true
    description: ID del cometido funcionario asociado

  # Conductor
  - name: conductor_id
    type: String
    fk: ROL-FUNCIONARIO
    nullable: false

  - name: conductor_nombre
    type: String
    nullable: false

  - name: licencia_clase
    type: String
    nullable: true

  # Pasajeros
  - name: pasajeros
    type: List[String]
    nullable: true

  - name: cantidad_pasajeros
    type: Integer
    default: 0

  # Combustible
  - name: carga_combustible
    type: Boolean
    default: false

  - name: litros_cargados
    type: Decimal
    nullable: true

  - name: vale_combustible
    type: String
    nullable: true

  - name: estacion_servicio
    type: String
    nullable: true

  # Estado
  - name: estado
    type: Enum[EnCurso, Completado, Incidente]
    default: EnCurso

  - name: observaciones
    type: Text
    nullable: true

  # Autorización
  - name: autorizado_por_id
    type: String
    fk: ROL-JEFE-UNIDAD
    nullable: true

  - name: fecha_autorizacion
    type: DateTime
    nullable: true

invariants:
  - name: km_coherente
    rule: "IF km_retorno NOT NULL THEN km_retorno >= km_salida"

  - name: horario_laboral
    rule: "fecha_salida.hora BETWEEN 08:00 AND 18:00 OR es_fin_semana_autorizado"
    source: "DL 799"

  - name: combustible_documentado
    rule: "IF carga_combustible THEN vale_combustible NOT NULL"

morphisms:
  registra_uso: [ENT-BACK-VEHICULO]
  ejecutado_por: [ROL-FUNCIONARIO]
  autorizado_por: [ROL-JEFE-UNIDAD]
  vinculado_a: [Cometido]
