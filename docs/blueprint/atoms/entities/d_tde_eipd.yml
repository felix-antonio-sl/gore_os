# ==============================================================================
# GORE_OS Entity Atom: EvaluacionImpactoProteccionDatos (EIPD)
# ==============================================================================
# Domain: D-TDE (Transformación Digital del Estado)
# Subdomain: Protección de Datos Personales
# Source: Ley 21.719, Art. 15 ter
# ==============================================================================

_metadata:
  version: "1.0.0"
  status: active
  created_at: "2025-12-22"
  created_by: "Arquitecto Categórico + DigiTrans"
  domain: D-TDE
  subdomain: proteccion_datos
  kb_source:
    - "urn:knowledge:tde:leyes:ley_21719_datos_personales:1.0.0"
    - "dialogo_legislativo_d_tde.md"

entity:
  id: ENT-TDE-EIPD
  name: EvaluacionImpactoProteccionDatos
  name_es: Evaluación de Impacto en Protección de Datos
  description: |
    Evaluación previa obligatoria que debe realizar el responsable
    cuando un tipo de tratamiento pueda producir un alto riesgo
    para los derechos de los titulares de datos personales.

    Requisito Art. 15 ter Ley 21.719.

  purpose: |
    Documentar el análisis de riesgo previo al tratamiento para:
    - Identificar riesgos para derechos y libertades de titulares
    - Definir medidas de mitigación
    - Consultar a la APDP si el riesgo es muy alto
    - Demostrar diligencia debida ante fiscalización

  categorical_type: Document
  is_abstract: false
  category: Compliance

attributes:
  # Identificación
  - name: id_eipd
    type: String
    key: true

  - name: responsable_id
    type: String
    fk: ENT-TDE-RESPONSABLE-TRATAMIENTO
    nullable: false

  # Evaluación
  - name: fecha_realizacion
    type: Date
    nullable: false

  - name: tipo_tratamiento_evaluado
    type: String
    nullable: false
    description: "Descripción del tratamiento analizado"

  - name: causal_obligatoriedad
    type: Enum[PerfilamientoAutomatizado, TratamientoMasivo, MonitoreoPublico, DatosSensiblesSinConsentimiento, Otro]
    nullable: false
    description: "Motivo por el que la EIPD es obligatoria"

  # Riesgo
  - name: nivel_riesgo_inherente
    type: Enum[Bajo, Medio, Alto, MuyAlto]
    nullable: false

  - name: nivel_riesgo_residual
    type: Enum[Bajo, Medio, Alto, MuyAlto]
    nullable: false
    description: "Riesgo después de aplicar mitigaciones"

  - name: medidas_mitigacion
    type: Array[String]
    nullable: false

  # Consulta APDP
  - name: requiere_consulta_apdp
    type: Boolean
    computed: true
    formula: nivel_riesgo_residual = 'MuyAlto'

  - name: consultado_agencia
    type: Boolean
    default: false

  - name: fecha_consulta_agencia
    type: Date
    nullable: true

  - name: respuesta_agencia
    type: String
    nullable: true

  # Documento
  - name: documento_url
    type: String
    nullable: true
    description: "Link al documento completo de la EIPD"

  - name: version
    type: String
    default: "1.0"

invariants:
  - id: INV-EIPD-001
    name: consulta_si_muy_alto
    rule: nivel_riesgo_residual = 'MuyAlto' → consultado_agencia = TRUE
    description: "Si el riesgo residual es muy alto, debe consultarse a la APDP"

  - id: INV-EIPD-002
    name: mitigacion_obligatoria
    rule: LENGTH(medidas_mitigacion) > 0
    description: "Debe existir al menos una medida de mitigación"

morphisms:
  realizada_por: [ENT-TDE-RESPONSABLE-TRATAMIENTO]
  evalua: [ENT-TDE-ACTIVO-DATOS]
  consultada_ante: [ENT-TDE-AGENCIA-PROTECCION-DATOS]

audit:
  fields_tracked:
    - nivel_riesgo_inherente
    - nivel_riesgo_residual
    - consultado_agencia
  retention_years: 10
  legal_basis: "Ley 21.719, Art. 15 ter"
