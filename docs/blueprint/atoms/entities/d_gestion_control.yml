# ==============================================================================
# GORE_OS Entity Atom: Control (Control de Riesgo)
# ==============================================================================
# Domain: D-GESTION (Control de Gestión y Operación)
# Subdomain: Unidad de Control (UC)
# Source: domain_d-gestion.md M4, Res. 30/2015 CGR
# ==============================================================================

_metadata:
  version: "1.0.0"
  status: active
  created_at: "2025-12-22"
  created_by: "Arquitecto Categórico + AR Virtual"
  domain: D-GESTION
  subdomain: uc
  kb_source:
    - "domain_d-gestion.md M4: UC"
    - "Res. 30/2015 CGR"
    - "dialogo_riguroso_d_gestion.md"

entity:
  id: ENT-GESTION-CONTROL
  name: Control
  name_es: Control de Riesgo
  description: |
    Medida de control asociada a un riesgo institucional.

    Tipos de control:
    - Preventivo: Evita que el riesgo se materialice
    - Detectivo: Identifica materialización temprana
    - Correctivo: Mitiga impacto post-materialización

    La efectividad se evalúa periódicamente y se reporta a CGR.

  purpose: |
    Modelar controles para:
    - Asociar medidas a riesgos específicos
    - Evaluar efectividad periódicamente
    - Documentar evidencias para CGR
    - Calcular riesgo residual

  categorical_type: Object
  is_abstract: false
  category: Transactional

attributes:
  - name: id_control
    type: String
    key: true
    description: "Identificador único (ej: CTL-2025-001)"

  - name: codigo
    type: String
    nullable: false
    description: "Código corto (ej: CTL-FIN-001)"

  - name: riesgo_id
    type: String
    fk: ENT-GESTION-RIESGO
    nullable: false
    description: Riesgo que mitiga

  - name: nombre
    type: String
    nullable: false
    description: Nombre del control

  - name: descripcion
    type: Text
    nullable: false
    description: Descripción del control

  # Clasificación
  - name: tipo
    type: Enum[Preventivo, Detectivo, Correctivo]
    nullable: false
    description: Tipo de control

  - name: naturaleza
    type: Enum[Manual, Automatico, Mixto]
    default: Manual
    description: Naturaleza de ejecución

  - name: frecuencia
    type: Enum[Continuo, Diario, Semanal, Mensual, Trimestral, Anual]
    nullable: false
    description: Frecuencia de aplicación

  # Responsabilidad
  - name: responsable_id
    type: String
    fk: ENT-BACK-FUNCIONARIO
    nullable: false
    description: Responsable de ejecutar el control

  - name: division_id
    type: String
    fk: ENT-BACK-DIVISION
    nullable: true
    description: División responsable

  # Evidencia
  - name: evidencia_requerida
    type: Text
    nullable: false
    description: Documentación que acredita ejecución

  - name: ubicacion_evidencia
    type: String
    nullable: true
    description: Ruta o sistema donde se guarda

  # Efectividad
  - name: efectividad
    type: Enum[Efectivo, ParcialmenteEfectivo, NoEfectivo, NoEvaluado]
    default: NoEvaluado
    description: Resultado de última evaluación

  - name: fecha_ultima_evaluacion
    type: Date
    nullable: true
    description: Fecha última evaluación

  - name: evaluador_id
    type: String
    fk: ENT-BACK-FUNCIONARIO
    nullable: true
    description: Quien evaluó efectividad

  - name: observaciones_evaluacion
    type: Text
    nullable: true
    description: Notas de la evaluación

  # Estado
  - name: estado
    type: Enum[Activo, Suspendido, EnMejora, Descontinuado]
    default: Activo
    description: Estado del control

  - name: fecha_implementacion
    type: Date
    nullable: true
    description: Fecha de implementación

  # CGR
  - name: observaciones_cgr
    type: Text
    nullable: true
    description: Observaciones de auditoría CGR

  - name: hallazgo_cgr_id
    type: String
    nullable: true
    description: ID de hallazgo CGR asociado

invariants:
  - id: INV-CTL-001
    name: riesgo_existente
    rule: riesgo_id IS NOT NULL
    description: Todo control debe estar asociado a un riesgo
    severity: error

  - id: INV-CTL-002
    name: efectividad_requiere_evaluacion
    rule: |
      efectividad != 'NoEvaluado' → fecha_ultima_evaluacion IS NOT NULL
    description: Controles evaluados deben tener fecha
    severity: warning

  - id: INV-CTL-003
    name: frecuencia_coherente
    rule: |
      naturaleza = 'Automatico' → frecuencia IN ('Continuo', 'Diario')
    description: Controles automáticos deben ser frecuentes
    severity: info

morphisms:
  mitiga: [ENT-GESTION-RIESGO]
  ejecutado_por: [ENT-BACK-FUNCIONARIO]
  auditado_por: [CGR]

audit:
  fields_tracked:
    - efectividad
    - estado
    - fecha_ultima_evaluacion
  retention_years: 10
