# ═══════════════════════════════════════════════════════════════════════════════
# ENT-FIN-TRANSFERENCIA | Transferencia de Recursos a Ejecutor
# Dominio: D-FIN
# Subdominio: Rendiciones
# Fuente: kb_gn_020_gestion_rendiciones_koda.yml, Resolución 30/2015 CGR
# ═══════════════════════════════════════════════════════════════════════════════
version: "1.0.0"

_meta:
  urn: urn:goreos:atom:entity:d_fin_rendiciones_transferencia:1.0.0
  type: Entity
  source: kb_gn_020_gestion_rendiciones_koda.yml
  created_at: "2025-12-22"

metadata:
  entity_id: ENT-FIN-TRANSFERENCIA
  name: Transferencia
  domain: D-FIN
  subdomain: rendiciones
  description: |
    Giro de recursos desde el GORE hacia un ejecutor (Municipio, ONG, Servicio).
    Representa el momento en que se libera el pago asociado a un convenio,
    ya sea en una sola cuota o en cuotas programadas.
  legal_basis:
    - Resolución 30/2015 CGR
    - DL 1263/1975 Art. 70
    - LOC GORE Art. 70

# ═══════════════════════════════════════════════════════════════════════════════
# ATRIBUTOS
# ═══════════════════════════════════════════════════════════════════════════════
attributes:
  - name: id_transferencia
    type: String
    key: true

  - name: convenio_id
    type: String
    fk: ENT-FIN-CONVENIO
    nullable: false
    description: Convenio que origina la transferencia

  - name: ipr_id
    type: String
    fk: ENT-FIN-IPR
    nullable: true
    description: IPR asociada (IDI, PPR, etc.)

  - name: ejecutor_id
    type: String
    fk: ENT-FIN-ACTOR_IPR
    nullable: false
    description: Receptor de los fondos

  - name: ejecutor_rut
    type: String
    nullable: false

  - name: ejecutor_nombre
    type: String
    nullable: false

  # ─────────────────────────────────────────────────────────────────────────────
  # Montos
  # ─────────────────────────────────────────────────────────────────────────────
  - name: monto_transferido
    type: Decimal
    nullable: false

  - name: moneda
    type: Enum[CLP, UF, USD]
    default: CLP

  # ─────────────────────────────────────────────────────────────────────────────
  # Cuotas
  # ─────────────────────────────────────────────────────────────────────────────
  - name: cuota_numero
    type: Integer
    default: 1
    description: Número de cuota (1 si es pago único)

  - name: total_cuotas
    type: Integer
    default: 1
    description: Total de cuotas programadas

  - name: es_ultima_cuota
    type: Boolean
    computed: true
    formula: cuota_numero = total_cuotas

  # ─────────────────────────────────────────────────────────────────────────────
  # Resolución de Giro
  # ─────────────────────────────────────────────────────────────────────────────
  - name: numero_resolucion
    type: String
    nullable: false
    description: Resolución que autoriza el giro

  - name: fecha_resolucion_giro
    type: Date
    nullable: false

  - name: tipo_resolucion
    type: Enum[ResolucionExenta, Decreto]
    default: ResolucionExenta

  # ─────────────────────────────────────────────────────────────────────────────
  # Operación Bancaria
  # ─────────────────────────────────────────────────────────────────────────────
  - name: fecha_giro_efectivo
    type: Date
    nullable: true
    description: Fecha del depósito bancario

  - name: cuenta_bancaria_destino
    type: String
    nullable: true
    description: Cuenta corriente del ejecutor

  - name: banco_destino
    type: String
    nullable: true

  - name: numero_operacion_bancaria
    type: String
    nullable: true
    description: Comprobante de transferencia electrónica

  # ─────────────────────────────────────────────────────────────────────────────
  # Imputación Presupuestaria
  # ─────────────────────────────────────────────────────────────────────────────
  - name: imputacion_presupuestaria
    type: String
    nullable: false
    description: Código clasificador (ej. 33.03.001)

  - name: cdp_id
    type: String
    fk: ENT-FIN-CDP
    nullable: true

  - name: devengado_id
    type: String
    fk: ENT-FIN-DEVENGO
    nullable: true

  # ─────────────────────────────────────────────────────────────────────────────
  # Estado
  # ─────────────────────────────────────────────────────────────────────────────
  - name: estado
    type: Enum[Pendiente, EnTramite, Girado, Confirmado, Reintegrado]
    default: Pendiente

  - name: fecha_confirmacion
    type: Date
    nullable: true
    description: Fecha en que ejecutor confirma recepción

  # ─────────────────────────────────────────────────────────────────────────────
  # SIGFE
  # ─────────────────────────────────────────────────────────────────────────────
  - name: folio_sigfe
    type: String
    nullable: true

# ═══════════════════════════════════════════════════════════════════════════════
# INVARIANTES
# ═══════════════════════════════════════════════════════════════════════════════
invariants:
  - id: INV-TRANS-001
    name: monto_positivo
    rule: monto_transferido > 0
    description: El monto transferido debe ser positivo

  - id: INV-TRANS-002
    name: cuota_valida
    rule: cuota_numero <= total_cuotas
    description: El número de cuota no puede exceder el total

  - id: INV-TRANS-003
    name: giro_requiere_resolucion
    rule: estado IN ('Girado', 'Confirmado') → numero_resolucion IS NOT NULL
    description: El giro requiere resolución aprobatoria

  - id: INV-TRANS-004
    name: confirmacion_requiere_giro
    rule: fecha_confirmacion IS NOT NULL → fecha_giro_efectivo IS NOT NULL
    description: No puede confirmarse sin haberse girado

# ═══════════════════════════════════════════════════════════════════════════════
# MORFISMOS
# ═══════════════════════════════════════════════════════════════════════════════
morphisms:
  financia_a: [ENT-FIN-CONVENIO]
  recibido_por: [ENT-FIN-ACTOR_IPR]
  genera: [ENT-FIN-RENDICIONES-RENDICION]
  afecta: [ENT-FIN-CDP, ENT-FIN-DEVENGO]
  autorizado_por: [ENT-NORM-ACTO]

audit:
  fields_tracked:
    - estado
    - monto_transferido
    - fecha_giro_efectivo
  retention_years: 10
