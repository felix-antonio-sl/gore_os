# Entidad: ModificacionConvenio
# Domain: D-EJEC
# Generated: 2025-12-21 (Phase 20.2)

id: ENT-EJEC-MODIFICACION_CONVENIO
urn: "urn:goreos:entity:d-ejec:modificacion-convenio:1.0.0"
name: Modificación de Convenio
domain: D-EJEC
category: Legal
canonical_source:
  - "domain_d-ejec.md#gestión-de-convenios"
  - "D.S. 148, Glosa 01 Circular 11"

description: |
  Registro de modificaciones a convenios vigentes.
  Tipos: Addendum, Prórroga, Cambio de Monto, Cambio de Alcance.
  Restricciones: >10% o >7.000 UTM requiere reevaluación MDSyF.

attributes:
  - name: id_modificacion
    type: String
    key: true

  - name: convenio_id
    type: String
    fk: ENT-FIN-CONVENIO
    nullable: false

  - name: numero_modificacion
    type: Integer
    nullable: false

  # Tipo
  - name: tipo_modificacion
    type: Enum[Addendum, Prorroga, AumentoCosto, DisminucionCosto, CambioAlcance, CambioEjecutor, CambioResponsable, Otro]
    nullable: false

  # Contenido
  - name: descripcion
    type: Text
    nullable: false

  - name: justificacion
    type: Text
    nullable: false

  # Valores originales
  - name: monto_original
    type: Decimal
    nullable: true

  - name: plazo_original_meses
    type: Integer
    nullable: true

  - name: fecha_termino_original
    type: Date
    nullable: true

  # Nuevos valores
  - name: monto_nuevo
    type: Decimal
    nullable: true

  - name: plazo_nuevo_meses
    type: Integer
    nullable: true

  - name: fecha_termino_nueva
    type: Date
    nullable: true

  # Variación
  - name: variacion_monto
    type: Decimal
    computed: true

  - name: variacion_pct
    type: Decimal
    computed: true
    formula: (monto_nuevo - monto_original) / monto_original * 100

  - name: variacion_dias_plazo
    type: Integer
    computed: true

  # Validaciones
  - name: requiere_reevaluacion_mdsf
    type: Boolean
    computed: true
    description: "Si variación > 10% o > 7.000 UTM"

  - name: requiere_acuerdo_core
    type: Boolean
    computed: true

  - name: resolucion_rs_nueva
    type: String
    nullable: true
    description: Identificador de la nueva RO/RS de MDSyF si hubo reevaluación (Phase 20.2 Enrichment)

  - name: fecha_rs_nueva
    type: Date
    nullable: true

  # Acto administrativo
  - name: resolucion_numero
    type: String
    nullable: true

  - name: fecha_resolucion
    type: Date
    nullable: true

  - name: acto_administrativo_id
    type: String
    nullable: true

  # Fechas
  - name: fecha_solicitud
    type: Date
    nullable: false

  - name: fecha_aprobacion
    type: Date
    nullable: true

  - name: fecha_vigencia
    type: Date
    nullable: true

  # Estado
  - name: estado
    type: Enum[Solicitada, EnRevision, Aprobada, Rechazada, Vigente]
    default: Solicitada

  # Documento
  - name: documento_url
    type: String
    nullable: true

invariants:
  - name: umbral_reevaluacion
    rule: "IF variacion_pct > 10 OR variacion_monto > 7000_UTM THEN requiere_reevaluacion_mdsf = true"
    source: "Glosa 01, Circular 11 DIPRES"

  - name: prorroga_justificada
    rule: "IF tipo_modificacion = Prorroga THEN justificacion NOT NULL"

morphisms:
  modifica: [ENT-FIN-CONVENIO]
  aprobada_por: [CORE, GORE]
  puede_requerir: [MDSF]
  formalizada_en: [ActoAdministrativo]
