# ==============================================================================
# GORE_OS Entity Atom: PostulacionSubvencion8
# ==============================================================================
# Domain: D-FIN (Financial Management)
# Subdomain: Mecanismos de Asignación
# Source: kb_gn_028_instructivo_subvencion_8_koda.yml
# ==============================================================================

_metadata:
  version: "1.0.0"
  status: draft
  created_at: "2025-12-21"
  created_by: "Arquitecto Categórico + Gestor IPR 360"
  domain: D-FIN
  subdomain: mecanismos
  kb_source:
    - "kb_gn_028_instructivo_subvencion_8_koda.yml"

entity:
  id: ENT-FIN-POST-SUBV8
  name: PostulacionSubvencion8
  name_es: Postulación Subvención 8%
  description: |
    Postulación de una organización ciudadana o municipalidad al Concurso de
    Vinculación con la Comunidad 8%. Registra la iniciativa propuesta, los
    documentos presentados, el proceso de admisibilidad, evaluación técnica
    y resultado final (adjudicación o rechazo).

    Las postulaciones se realizan en línea vía www.goredenuble.cl y deben
    cumplir con la documentación obligatoria del instructivo.

  purpose: |
    Modelar el ciclo completo de postulación ciudadana al 8% para:
    - Registrar iniciativas y documentación presentada
    - Aplicar checklists de admisibilidad por fondo
    - Calcular puntaje técnico ponderado
    - Gestionar adjudicación y convenio posterior

  categorical_type: Object
  is_abstract: false

  extends: null

  related_to:
    - entity: ENT-FIN-CONV-SUBV8
      relation: postula_a
      cardinality: N:1
      description: Cada postulación corresponde a una convocatoria específica
    - entity: ENT-ORG-ORGANIZACION
      relation: presentada_por
      cardinality: N:1
      description: La organización postulante
    - entity: ENT-FIN-CONVENIO
      relation: genera
      cardinality: 1:0..1
      description: Si adjudicada, genera un convenio de subvención
    - entity: ENT-PERSONA
      relation: formulada_por
      cardinality: N:1
      description: Persona que formula la postulación

attributes:
  - name: id_postulacion
    type: String
    key: true
    description: Identificador único de la postulación

  - name: convocatoria_id
    type: String
    fk: ENT-FIN-CONV-SUBV8
    nullable: false
    description: Convocatoria a la que postula

  - name: organizacion_postulante_id
    type: String
    fk: ENT-ORG-ORGANIZACION
    nullable: false
    description: Organización que presenta la iniciativa

  - name: tipo_organizacion
    type: Enum[PRIV_SFL, ORG_COMUNITARIA, ORG_ADULTO_MAYOR, MUNICIPALIDAD]
    nullable: false
    description: Tipo de organización postulante

  - name: nombre_iniciativa
    type: String
    nullable: false
    description: Nombre del proyecto o iniciativa

  - name: area_postulacion
    type: String
    nullable: false
    description: Área temática a la que postula dentro del fondo

  - name: monto_solicitado
    type: Decimal
    nullable: false
    description: Monto de financiamiento solicitado

  - name: fecha_ingreso
    type: DateTime
    nullable: false
    description: Timestamp de ingreso de la postulación

  - name: estado
    type: Enum[Ingresada, EnRevisionAdmisibilidad, Admisible, AdmisibleConObservaciones, Inadmisible, EnEvaluacionTecnica, Recomendada, NoRecomendada, ListaEspera, Adjudicada, Rechazada, Renunciada]
    default: Ingresada
    description: Estado actual de la postulación

  # Datos de la organización
  - name: antiguedad_organizacion_anios
    type: Integer
    nullable: false
    description: Años desde constitución (mínimo 2 requerido)

  - name: domicilio_region_nuble
    type: Boolean
    nullable: false
    description: Si tiene domicilio en la Región de Ñuble

  - name: experiencia_area
    type: Boolean
    nullable: false
    description: Si demuestra experiencia en el área de postulación

  - name: tiene_rendiciones_pendientes
    type: Boolean
    default: false
    description: Si tiene rendiciones pendientes con GORE

  # Documentación
  - name: carta_solicitud_recursos
    type: Boolean
    default: false
    description: Carta dirigida al Gobernador Regional

  - name: carta_aceptacion_terminos
    type: Boolean
    default: false
    description: Aceptación de términos y condiciones

  - name: rut_organizacion_adjunto
    type: Boolean
    default: false
    description: Fotocopia RUT organización

  - name: cedula_representante_adjunta
    type: Boolean
    default: false
    description: Cédula identidad representante legal

  - name: certificado_directorio_vigente
    type: Boolean
    default: false
    description: Certificado directorio (max 30 días)

  - name: inscripcion_registro_19862
    type: Boolean
    default: false
    description: Inscripción Registro Colaboradores Estado

  - name: cuenta_bancaria_adjunta
    type: Boolean
    default: false
    description: Libreta ahorro o certificado bancario

  - name: cotizaciones_adjuntas
    type: Boolean
    default: false
    description: Cotizaciones por ítem (equipamiento, gestión, difusión)

  - name: formulario_postulacion_completo
    type: Boolean
    default: false
    description: Formulario de presentación completo

  - name: planilla_presupuesto_adjunta
    type: Boolean
    default: false
    description: Planilla de presupuesto

  - name: documentos_adicionales
    type: Array[String]
    nullable: true
    description: Documentos adicionales según fondo (ej. carta apoyo uso espacio)

  # Admisibilidad
  - name: fecha_revision_admisibilidad
    type: Date
    nullable: true
    description: Fecha de revisión de admisibilidad

  - name: observaciones_admisibilidad
    type: String
    nullable: true
    description: Observaciones del proceso de admisibilidad

  - name: plazo_subsanacion
    type: Date
    nullable: true
    description: Fecha límite para subsanar observaciones

  - name: subsanacion_presentada
    type: Boolean
    nullable: true
    description: Si presentó subsanación

  # Evaluación técnica
  - name: puntaje_tecnico
    type: Decimal
    nullable: true
    description: Puntaje técnico (escala 1-7)

  - name: fecha_evaluacion_tecnica
    type: Date
    nullable: true
    description: Fecha de evaluación técnica

  - name: evaluador_id
    type: String
    nullable: true
    description: ID del evaluador asignado

  - name: observaciones_evaluacion
    type: String
    nullable: true
    description: Observaciones técnicas del evaluador

  # Adjudicación
  - name: monto_adjudicado
    type: Decimal
    nullable: true
    description: Monto finalmente adjudicado (puede diferir del solicitado)

  - name: fecha_adjudicacion
    type: Date
    nullable: true
    description: Fecha de adjudicación

  - name: es_excepcion_doble_postulacion
    type: Boolean
    default: false
    description: |
      Si es segunda postulación bajo excepción:
      - Organismos Mejor Niñez (área Residencias)
      - Instituciones deporte/cultura con representación

  - name: convenio_id
    type: String
    fk: ENT-FIN-CONVENIO
    nullable: true
    description: Convenio generado si fue adjudicada

  # Formulador
  - name: nombre_formulador
    type: String
    nullable: false
    description: Nombre del formulador de la iniciativa

  - name: email_formulador
    type: String
    nullable: false
    description: Correo electrónico del formulador

  - name: vinculo_formulador
    type: String
    nullable: true
    description: Relación del formulador con la organización

invariants:
  - id: INV-POST8-001
    name: una_postulacion_por_organizacion
    rule: |
      COUNT(PostulacionSubvencion8 WHERE 
            organizacion_postulante_id = THIS.organizacion_postulante_id 
            AND convocatoria_id.anio_presupuestario = THIS.convocatoria_id.anio_presupuestario
            AND es_excepcion_doble_postulacion = false) <= 1
    description: Organizaciones pueden postular solo a una iniciativa por año
    exception: Mejor Niñez (Residencias) e instituciones con representación pueden más
    source: kb_gn_028 Sec. 1 Regla General

  - id: INV-POST8-002
    name: antiguedad_minima_2_anios
    rule: antiguedad_organizacion_anios >= 2
    description: La organización debe tener mínimo 2 años de antigüedad
    source: kb_gn_028 Requisitos Postulantes
    severity: error

  - id: INV-POST8-003
    name: domicilio_en_nuble
    rule: domicilio_region_nuble = true
    description: La organización debe tener domicilio en Región de Ñuble
    source: kb_gn_028 Requisitos Postulantes
    severity: error

  - id: INV-POST8-004
    name: sin_rendiciones_pendientes
    rule: tiene_rendiciones_pendientes = false
    description: No puede tener rendiciones pendientes con GORE
    source: kb_gn_028 Requisitos Postulantes
    severity: error

  - id: INV-POST8-005
    name: monto_no_excede_tope_area
    rule: |
      monto_solicitado <= 
      convocatoria_id.monto_tope_por_area[area_postulacion + '::' + tipo_organizacion]
    description: El monto solicitado no puede exceder el tope del área
    source: kb_gn_028 Montos Tope
    severity: error

  - id: INV-POST8-006
    name: puntaje_minimo_recomendacion
    rule: |
      (estado = 'Recomendada') → puntaje_tecnico >= 5.0
    description: Se requiere puntaje mínimo 5.0 para ser recomendada
    source: kb_gn_028 Sec. 2 Evaluación

  - id: INV-POST8-007
    name: montos_coinciden
    rule: |
      monto_solicitado = 
      carta_solicitud.monto = 
      planilla_presupuesto.total
    description: El monto debe coincidir en formulario, carta y planilla
    source: kb_gn_028 Sec. 1 Documentos
    severity: error

  - id: INV-POST8-008
    name: adjudicacion_requiere_admisible
    rule: |
      (estado = 'Adjudicada') → 
      (estado_previo IN ['Admisible', 'Recomendada'])
    description: Solo se puede adjudicar si es admisible y recomendada

  - id: INV-POST8-009
    name: adulto_mayor_exclusivo
    rule: |
      (convocatoria_id.fondo_id = 'ADULTO_MAYOR') → 
      tipo_organizacion = 'ORG_ADULTO_MAYOR'
    description: Fondo Adulto Mayor solo para organizaciones de AM
    source: kb_gn_028 Sec. 7

  - id: INV-POST8-010
    name: ingreso_antes_cierre
    rule: fecha_ingreso <= convocatoria_id.fecha_cierre
    description: Postulación debe ingresar antes del cierre
    severity: error

lifecycle:
  states:
    - name: Ingresada
      description: Postulación recibida en plataforma
    - name: EnRevisionAdmisibilidad
      description: En revisión de documentos y requisitos
    - name: Admisible
      description: Cumple todos los requisitos de admisibilidad
    - name: AdmisibleConObservaciones
      description: Admisible con observaciones menores a subsanar
    - name: Inadmisible
      description: No cumple requisitos de admisibilidad
    - name: EnEvaluacionTecnica
      description: En evaluación técnica por comisión
    - name: Recomendada
      description: Recomendada para adjudicación (puntaje >= 5.0)
    - name: NoRecomendada
      description: No recomendada por puntaje insuficiente
    - name: ListaEspera
      description: Recomendada pero sin presupuesto disponible
    - name: Adjudicada
      description: Recursos asignados
    - name: Rechazada
      description: No adjudicada
    - name: Renunciada
      description: Organización renunció a los recursos

  transitions:
    - from: Ingresada
      to: EnRevisionAdmisibilidad
      trigger: iniciar_revision
    - from: EnRevisionAdmisibilidad
      to: Admisible
      trigger: aprobar_admisibilidad
      guard: documentos_completos AND requisitos_cumplidos
    - from: EnRevisionAdmisibilidad
      to: AdmisibleConObservaciones
      trigger: aprobar_con_observaciones
    - from: EnRevisionAdmisibilidad
      to: Inadmisible
      trigger: rechazar_admisibilidad
    - from: AdmisibleConObservaciones
      to: Admisible
      trigger: subsanar
      guard: subsanacion_presentada AND fecha_actual <= plazo_subsanacion
    - from: AdmisibleConObservaciones
      to: Inadmisible
      trigger: vencer_plazo
      guard: fecha_actual > plazo_subsanacion AND NOT subsanacion_presentada
    - from: Admisible
      to: EnEvaluacionTecnica
      trigger: iniciar_evaluacion
    - from: EnEvaluacionTecnica
      to: Recomendada
      trigger: recomendar
      guard: puntaje_tecnico >= 5.0
    - from: EnEvaluacionTecnica
      to: NoRecomendada
      trigger: no_recomendar
      guard: puntaje_tecnico < 5.0
    - from: Recomendada
      to: Adjudicada
      trigger: adjudicar
      guard: presupuesto_disponible
    - from: Recomendada
      to: ListaEspera
      trigger: poner_en_espera
      guard: NOT presupuesto_disponible
    - from: ListaEspera
      to: Adjudicada
      trigger: adjudicar_desde_espera
    - from: ListaEspera
      to: Rechazada
      trigger: cerrar_sin_adjudicar
    - from: Adjudicada
      to: Renunciada
      trigger: renunciar

audit:
  fields_tracked:
    - estado
    - puntaje_tecnico
    - monto_adjudicado
    - fecha_adjudicacion
  retention_years: 6
